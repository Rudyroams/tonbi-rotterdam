<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Tonbi">
<meta name="mobile-web-app-capable" content="yes">
<title>Tonbi ¬∑ Rotterdam</title>
<link href="https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.css" rel="stylesheet">
<style>
#mapbox-map { width:100%; height:420px; }
.mapboxgl-popup-content { border-radius:12px; padding:0; overflow:hidden; box-shadow:0 4px 20px rgba(0,0,0,0.15); font-family:'DM Sans',sans-serif; min-width:180px; }
.popup-img { width:100%; height:90px; object-fit:cover; display:block; }
.popup-body { padding:0.75rem; }
.popup-num { font-size:0.6rem; font-weight:700; color:#ff6b35; text-transform:uppercase; letter-spacing:0.1em; margin-bottom:0.2rem; }
.popup-name { font-family:'Nunito',sans-serif; font-size:0.95rem; font-weight:800; margin-bottom:0.2rem; }
.popup-tag { font-size:0.72rem; color:#6e6e73; line-height:1.4; }
.popup-btn { display:block; background:#ff6b35; color:#fff; text-align:center; padding:0.5rem; font-family:'Nunito',sans-serif; font-size:0.8rem; font-weight:800; text-decoration:none; cursor:pointer; border:none; width:100%; margin-top:0.5rem; border-radius:8px; }
.mapboxgl-ctrl-logo { display:none !important; }

/* ‚îÄ‚îÄ Walking figure animation ‚îÄ‚îÄ */
@keyframes walkBob { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-4px)} }
@keyframes walkLegF { 0%,100%{transform:rotate(-30deg)} 50%{transform:rotate(30deg)} }
@keyframes walkLegB { 0%,100%{transform:rotate(30deg)} 50%{transform:rotate(-30deg)} }
@keyframes walkArmF { 0%,100%{transform:rotate(25deg)} 50%{transform:rotate(-25deg)} }
@keyframes walkArmB { 0%,100%{transform:rotate(-25deg)} 50%{transform:rotate(25deg)} }

/* ‚îÄ‚îÄ Confetti animation ‚îÄ‚îÄ */
@keyframes confettiFall0  { 0%{transform:translateY(-20px) rotate(0deg);opacity:1} 100%{transform:translateY(110vh) rotate(360deg);opacity:0} }
@keyframes confettiFall1  { 0%{transform:translateY(-20px) rotate(0deg);opacity:1} 100%{transform:translateY(110vh) rotate(-380deg);opacity:0} }
@keyframes confettiFall2  { 0%{transform:translateY(-20px) rotate(0deg);opacity:1} 100%{transform:translateY(110vh) rotate(420deg);opacity:0} }
@keyframes confettiFall3  { 0%{transform:translateY(-20px) rotate(0deg);opacity:1} 100%{transform:translateY(110vh) rotate(-300deg);opacity:0} }
@keyframes confettiFall4  { 0%{transform:translateY(-20px) rotate(0deg);opacity:1} 100%{transform:translateY(110vh) rotate(340deg);opacity:0} }
#confetti-overlay { pointer-events:none; }
.confetti-piece {
  position:absolute; width:12px; height:12px; border-radius:2px; opacity:0;
}

/* Hide jt-bar when fullscreen video card is showing */
#journey-screen.fullscreen-video #jt-bar { display:none !important; }
#journey-screen.fullscreen-video #progress-dots { display:none !important; }
</style>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Nunito:ital,wght@0,400;0,600;0,700;0,800;0,900;1,700&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #f8f7f5;
  --white: #ffffff;
  --black: #111111;
  --text: #1c1c1e;
  --text2: #6e6e73;
  --border: #e5e5ea;
  --orange: #ff6b35;
  --orange-light: #fff3ee;
  --blue: #2d6be4;
  --blue-light: #eef3fd;
  --green: #34c759;
  --green-light: #edfaf2;
  --red-light: #ffeef0;
  --red: #ff3b30;
  --yellow: #ffcc00;
  --yellow-light: #fffbe6;
  --radius: 18px;
  --radius-sm: 12px;
  --shadow: 0 2px 16px rgba(0,0,0,0.08);
  --shadow-lg: 0 8px 32px rgba(0,0,0,0.12);
}
* { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
body { font-family:'DM Sans',sans-serif; background:var(--bg); color:var(--text); min-height:100svh; overflow-x:hidden; }

/* ‚îÄ‚îÄ PASSWORD ‚îÄ‚îÄ */
#pw-screen {
  position:fixed; inset:0; background:var(--white);
  display:flex; flex-direction:column; align-items:center; justify-content:center;
  z-index:9999; padding:2.5rem 2rem; transition:opacity 0.5s, transform 0.5s;
}
#pw-screen.exit { opacity:0; transform:scale(0.97); pointer-events:none; }
.pw-logo { width:80px; height:80px; border-radius:22px; background:var(--orange); display:flex; align-items:center; justify-content:center; font-size:2.5rem; margin-bottom:1.25rem; box-shadow:0 8px 24px rgba(255,107,53,0.35); animation:float 3s ease-in-out infinite; }
@keyframes float { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-6px)} }
.pw-wordmark { font-family:'Nunito',sans-serif; font-size:2rem; font-weight:900; color:var(--text); letter-spacing:-0.02em; }
.pw-city { font-size:0.8rem; color:var(--text2); margin-bottom:2.5rem; }
.pw-field { width:100%; max-width:320px; background:var(--bg); border:2px solid var(--border); border-radius:var(--radius-sm); padding:0.9rem 1.25rem; font-family:'DM Sans',sans-serif; font-size:1rem; text-align:center; outline:none; transition:border-color 0.2s; margin-bottom:0.75rem; display:block; color:var(--text); }
.pw-field:focus { border-color:var(--orange); }
.pw-btn { width:100%; max-width:320px; background:var(--orange); color:#fff; border:none; border-radius:var(--radius-sm); padding:0.95rem; font-family:'Nunito',sans-serif; font-size:1rem; font-weight:800; cursor:pointer; transition:transform 0.15s, box-shadow 0.15s; box-shadow:0 4px 16px rgba(255,107,53,0.3); display:block; }
.pw-btn:hover { transform:translateY(-1px); }
.pw-error { color:var(--red); font-size:0.8rem; margin-top:0.6rem; height:1rem; text-align:center; }

/* ‚îÄ‚îÄ APP ‚îÄ‚îÄ */
#app { display:none; }
#app.show { display:block; }

/* ‚îÄ‚îÄ HOME ‚îÄ‚îÄ */
#home-screen { min-height:100svh; padding-bottom:calc(80px + env(safe-area-inset-bottom)); }
.home-header { padding:calc(1.5rem + env(safe-area-inset-top)) 1.25rem 1.25rem; background:var(--white); }
.home-header-top { display:flex; align-items:center; justify-content:space-between; margin-bottom:1.25rem; }
.home-logo { display:flex; align-items:center; gap:0.6rem; }
.home-logo-icon { width:36px; height:36px; border-radius:10px; background:var(--orange); display:flex; align-items:center; justify-content:center; font-size:1.1rem; }
.home-logo-name { font-family:'Nunito',sans-serif; font-size:1.2rem; font-weight:900; }
.home-logo-sub { font-size:0.65rem; color:var(--text2); }
.home-city-tag { background:var(--orange-light); color:var(--orange); font-size:0.7rem; font-weight:700; padding:0.35rem 0.75rem; border-radius:20px; }
.hero-card { margin:0 1.25rem 1.25rem; border-radius:var(--radius); overflow:hidden; position:relative; box-shadow:var(--shadow-lg); }
.hero-img { width:100%; aspect-ratio:4/3; object-fit:cover; display:block; }
.hero-overlay { position:absolute; inset:0; background:linear-gradient(to top, rgba(0,0,0,0.7) 0%, rgba(0,0,0,0.1) 60%, transparent 100%); padding:1.25rem; display:flex; flex-direction:column; justify-content:flex-end; }
.hero-label { font-size:0.65rem; letter-spacing:0.2em; text-transform:uppercase; color:rgba(255,255,255,0.7); margin-bottom:0.3rem; }
.hero-title { font-family:'Nunito',sans-serif; font-size:2rem; font-weight:900; color:#fff; line-height:1.1; }
.hero-desc { font-size:0.8rem; color:rgba(255,255,255,0.75); margin-top:0.3rem; line-height:1.5; }
.stats-row { display:flex; gap:0.75rem; margin:0 1.25rem 1.25rem; }
.stat-card { flex:1; background:var(--white); border-radius:var(--radius-sm); padding:0.85rem 0.5rem; text-align:center; box-shadow:var(--shadow); }
.stat-num { font-family:'Nunito',sans-serif; font-size:1.5rem; font-weight:900; line-height:1; }
.stat-lbl { font-size:0.6rem; color:var(--text2); margin-top:0.15rem; font-weight:500; text-transform:uppercase; letter-spacing:0.05em; }
.start-btn-wrap { margin:0 1.25rem 1.5rem; }
.start-btn { width:100%; background:var(--orange); color:#fff; border:none; border-radius:var(--radius-sm); padding:1rem; font-family:'Nunito',sans-serif; font-size:1.05rem; font-weight:800; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:0.5rem; box-shadow:0 4px 16px rgba(255,107,53,0.3); transition:transform 0.15s; }
.start-btn:hover { transform:translateY(-1px); }
.section-title { font-family:'Nunito',sans-serif; font-size:1.1rem; font-weight:800; padding:0 1.25rem; margin-bottom:0.75rem; }
.stop-item { margin:0 1.25rem 0.75rem; background:var(--white); border-radius:var(--radius); display:flex; align-items:center; overflow:hidden; box-shadow:var(--shadow); cursor:pointer; transition:transform 0.2s, box-shadow 0.2s; }
.stop-item:hover { transform:translateY(-2px); box-shadow:var(--shadow-lg); }
.stop-item-num { width:48px; flex-shrink:0; background:var(--orange); color:#fff; display:flex; align-items:center; justify-content:center; font-family:'Nunito',sans-serif; font-size:1.3rem; font-weight:900; align-self:stretch; }
.stop-item-img { width:80px; height:80px; object-fit:cover; flex-shrink:0; }
.stop-item-body { flex:1; padding:0.75rem 1rem; }
.stop-item-name { font-family:'Nunito',sans-serif; font-size:0.95rem; font-weight:800; margin-bottom:0.15rem; }
.stop-item-tag { font-size:0.72rem; color:var(--text2); line-height:1.4; }
.stop-item-badges { display:flex; gap:0.35rem; margin-top:0.4rem; }
.pill { font-size:0.58rem; font-weight:700; padding:0.2rem 0.5rem; border-radius:20px; text-transform:uppercase; letter-spacing:0.05em; }
.pill-photo { background:var(--orange-light); color:var(--orange); }
.pill-quiz { background:var(--blue-light); color:var(--blue); }
.stop-item-arrow { color:var(--border); font-size:1rem; padding-right:1rem; }

/* ‚îÄ‚îÄ JOURNEY ‚îÄ‚îÄ */
#journey-screen { position:fixed; inset:0; background:var(--bg); display:none; flex-direction:column; z-index:200; }
#journey-screen.show { display:flex; }
.jt-bar { background:var(--white); padding:calc(0.9rem + env(safe-area-inset-top)) 1.25rem 0.5rem; border-bottom:1px solid var(--border); flex-shrink:0; }
.jt-bar-top { display:flex; align-items:center; justify-content:space-between; margin-bottom:0.45rem; }
.jt-back { background:var(--bg); border:none; border-radius:20px; padding:0.4rem 1rem; font-family:'DM Sans',sans-serif; font-size:0.8rem; font-weight:500; color:var(--text2); cursor:pointer; }
.jt-stop-label { font-family:'Nunito',sans-serif; font-size:0.9rem; font-weight:800; }
.jt-close { background:var(--bg); border:none; border-radius:50%; width:32px; height:32px; font-size:1rem; cursor:pointer; color:var(--text2); display:flex; align-items:center; justify-content:center; }
.progress-dots { display:flex; gap:0.4rem; align-items:center; }
.dot { height:4px; border-radius:4px; background:var(--border); transition:all 0.3s; width:8px; }
.dot.active { background:var(--orange); width:20px; }
.dot.done { background:var(--orange); opacity:0.4; }
.card-viewport { flex:1; overflow:hidden; position:relative; min-height:0; }
.card-track { display:flex; height:100%; transition:transform 0.4s cubic-bezier(0.4,0,0.2,1); will-change:transform; }
.card { min-width:100%; height:100%; overflow-y:auto; -webkit-overflow-scrolling:touch; padding:1.25rem; scroll-behavior:smooth; }
.card.nav-card { padding:0; overflow:hidden; position:relative; }

/* ‚îÄ‚îÄ VIDEO CARD ‚îÄ‚îÄ */
.video-wrap {
  border-radius:var(--radius);
  overflow:hidden;
  background:#000;
  margin-bottom:0.75rem;
  position:relative;
  aspect-ratio:16/9;
  box-shadow:var(--shadow-lg);
}
/* Thumbnail + play button */
.video-thumb {
  position:absolute; inset:0;
  cursor:pointer;
  display:flex; align-items:center; justify-content:center;
  transition:opacity 0.3s;
}
.video-thumb img { width:100%; height:100%; object-fit:cover; display:block; }
.video-thumb-overlay { position:absolute; inset:0; background:rgba(0,0,0,0.25); display:flex; align-items:center; justify-content:center; }
.play-btn-circle {
  width:64px; height:64px; border-radius:50%;
  background:rgba(255,255,255,0.92);
  display:flex; align-items:center; justify-content:center;
  box-shadow:0 4px 24px rgba(0,0,0,0.3);
  transition:transform 0.2s;
}
.video-thumb:hover .play-btn-circle { transform:scale(1.08); }
.play-triangle { width:0; height:0; border-top:12px solid transparent; border-bottom:12px solid transparent; border-left:20px solid var(--orange); margin-left:4px; }
/* YouTube iframe */
.video-iframe-wrap { position:absolute; inset:0; display:none; }
.video-iframe-wrap iframe { width:100%; height:100%; border:none; }
.video-iframe-wrap.active { display:block; }
/* Skip link */
.video-skip { font-size:0.75rem; color:var(--text2); text-align:center; margin-bottom:1rem; }
.video-skip a { color:var(--blue); font-weight:500; text-decoration:none; cursor:pointer; }
.video-skip a:hover { text-decoration:underline; }

/* Arrival text section */
.arrival-stop-num { font-size:0.7rem; font-weight:700; color:var(--orange); text-transform:uppercase; letter-spacing:0.1em; margin-bottom:0.3rem; }
.arrival-title { font-family:'Nunito',sans-serif; font-size:2rem; font-weight:900; line-height:1.1; letter-spacing:-0.02em; margin-bottom:0.5rem; }
.arrival-tagline { font-size:0.9rem; color:var(--text2); line-height:1.6; margin-bottom:1.25rem; }
.arrival-map-btn { display:flex; align-items:center; gap:0.75rem; background:var(--white); border-radius:var(--radius-sm); padding:0.9rem 1rem; box-shadow:var(--shadow); text-decoration:none; color:var(--text); margin-bottom:0.75rem; transition:transform 0.15s; }
.arrival-map-btn:hover { transform:translateY(-1px); }
.arrival-map-icon { font-size:1.5rem; }
.arrival-map-text strong { display:block; font-size:0.85rem; font-weight:700; }
.arrival-map-text span { font-size:0.72rem; color:var(--text2); }
.arrival-map-arrow { margin-left:auto; color:var(--blue); font-weight:700; }

/* Text section (always visible below video) */
.arrival-text-section { background:var(--white); border-radius:var(--radius); padding:1.25rem; box-shadow:var(--shadow); margin-bottom:0.75rem; }
.arrival-text-label { font-size:0.65rem; font-weight:700; color:var(--text2); text-transform:uppercase; letter-spacing:0.1em; margin-bottom:0.6rem; }
.arrival-text-body { font-size:0.92rem; line-height:1.8; color:var(--text); font-weight:300; }

/* ‚îÄ‚îÄ OTHER CARD TYPES ‚îÄ‚îÄ */
.story-card-inner { background:var(--white); border-radius:var(--radius); padding:1.5rem; box-shadow:var(--shadow); margin-bottom:1rem; }
.story-avatar { width:44px; height:44px; border-radius:50%; background:var(--orange); display:flex; align-items:center; justify-content:center; font-family:'Nunito',sans-serif; font-size:1.1rem; font-weight:900; color:#fff; margin-bottom:1rem; }
.story-from { font-size:0.65rem; font-weight:700; color:var(--orange); text-transform:uppercase; letter-spacing:0.1em; margin-bottom:0.5rem; }
.story-text { font-size:0.92rem; line-height:1.75; color:var(--text); }
.photo-card { background:var(--white); border-radius:var(--radius); overflow:hidden; box-shadow:var(--shadow); }
.photo-card-header { background:var(--orange); padding:1.25rem; }
.photo-card-label { font-size:0.65rem; font-weight:700; color:rgba(255,255,255,0.75); text-transform:uppercase; letter-spacing:0.1em; margin-bottom:0.3rem; }
.photo-card-title { font-family:'Nunito',sans-serif; font-size:1.4rem; font-weight:900; color:#fff; }
.photo-card-body { padding:1.25rem; }
.photo-card-desc { font-size:0.9rem; line-height:1.75; color:var(--text); margin-bottom:1rem; }
.photo-tip-box { background:var(--yellow-light); border-radius:var(--radius-sm); padding:0.9rem 1rem; display:flex; gap:0.6rem; align-items:flex-start; margin-bottom:1.25rem; }
.photo-tip-icon { font-size:1.1rem; flex-shrink:0; margin-top:0.1rem; }
.photo-tip-text { font-size:0.82rem; line-height:1.6; color:var(--text); }
.photo-tip-text strong { color:#996600; font-weight:700; display:block; margin-bottom:0.15rem; font-size:0.72rem; text-transform:uppercase; letter-spacing:0.05em; }
.open-cam-btn { width:100%; background:var(--orange); color:#fff; border:none; border-radius:var(--radius-sm); padding:0.95rem; font-family:'Nunito',sans-serif; font-size:1rem; font-weight:800; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:0.5rem; box-shadow:0 4px 16px rgba(255,107,53,0.25); transition:transform 0.15s; }
.open-cam-btn:hover { transform:translateY(-1px); }

/* ‚îÄ‚îÄ QUIZ ‚îÄ‚îÄ */
.quiz-card { background:var(--white); border-radius:var(--radius); overflow:hidden; box-shadow:var(--shadow); }
.quiz-card-img { width:100%; aspect-ratio:16/9; object-fit:cover; display:block; }
.quiz-card-body { padding:1.25rem; }
.quiz-card-label { font-size:0.65rem; font-weight:700; color:var(--blue); text-transform:uppercase; letter-spacing:0.1em; margin-bottom:0.6rem; }
.quiz-card-q { font-family:'Nunito',sans-serif; font-size:1.05rem; font-weight:800; line-height:1.4; margin-bottom:1.1rem; }
.quiz-opts { display:flex; flex-direction:column; gap:0.6rem; margin-bottom:1rem; }
.quiz-o { background:var(--bg); border:2px solid var(--border); border-radius:var(--radius-sm); padding:0.85rem 1rem; font-size:0.88rem; font-weight:500; cursor:pointer; text-align:left; width:100%; font-family:'DM Sans',sans-serif; display:flex; align-items:center; gap:0.75rem; transition:border-color 0.2s, background 0.2s; color:var(--text); }
.quiz-o:hover:not([disabled]) { border-color:var(--blue); background:var(--blue-light); }
.quiz-o.correct { background:var(--green-light); border-color:var(--green); }
.quiz-o.wrong { background:var(--red-light); border-color:var(--red); }
.quiz-o-icon { width:22px; height:22px; border-radius:50%; background:var(--border); display:flex; align-items:center; justify-content:center; font-size:0.7rem; flex-shrink:0; font-weight:700; }
.quiz-o.correct .quiz-o-icon { background:var(--green); color:#fff; }
.quiz-o.wrong .quiz-o-icon { background:var(--red); color:#fff; }
.quiz-result-box { border-radius:var(--radius-sm); padding:1rem; font-size:0.85rem; line-height:1.65; display:none; }
.quiz-result-box.show { display:block; }
.quiz-result-box.correct-res { background:var(--green-light); color:#1a6b2f; }
.quiz-result-box.wrong-res { background:var(--red-light); color:#b31c13; }
.quiz-result-box strong { font-weight:800; display:block; margin-bottom:0.2rem; }

/* ‚îÄ‚îÄ CARD BOTTOM ‚îÄ‚îÄ */
.card-bottom { flex-shrink:0; background:var(--white); border-top:1px solid var(--border); padding:0.5rem 1rem calc(0.5rem + env(safe-area-inset-bottom)); display:flex; gap:0.6rem; transition:background 0.3s, border-color 0.3s, backdrop-filter 0.3s; }
.card-bottom.on-map { background:rgba(255,255,255,0.75); border-top-color:transparent; backdrop-filter:blur(12px); -webkit-backdrop-filter:blur(12px); }
.card-prev-btn { background:var(--bg); border:none; border-radius:var(--radius-sm); padding:0.55rem 1rem; font-family:'Nunito',sans-serif; font-size:0.85rem; font-weight:800; color:var(--text2); cursor:pointer; flex-shrink:0; }
.card-next-btn { flex:1; background:var(--orange); color:#fff; border:none; border-radius:var(--radius-sm); padding:0.55rem; font-family:'Nunito',sans-serif; font-size:0.9rem; font-weight:800; cursor:pointer; box-shadow:0 4px 12px rgba(255,107,53,0.25); transition:transform 0.15s; }
.card-next-btn:hover { transform:translateY(-1px); }
.card-next-btn.final { background:var(--green); box-shadow:0 4px 12px rgba(52,199,89,0.25); }

/* ‚îÄ‚îÄ MAP ‚îÄ‚îÄ */
#map-screen { display:none; min-height:100svh; padding-bottom:calc(80px + env(safe-area-inset-bottom)); }
#map-screen.show { display:block; }
.map-top { padding:calc(1.5rem + env(safe-area-inset-top)) 1.25rem 1rem; background:var(--white); border-bottom:1px solid var(--border); }
.map-top-title { font-family:'Nunito',sans-serif; font-size:1.4rem; font-weight:900; margin-bottom:0.2rem; }
.map-top-sub { font-size:0.8rem; color:var(--text2); }
.map-placeholder-box { margin:1.25rem; background:var(--white); border-radius:var(--radius); overflow:hidden; box-shadow:var(--shadow); }
.map-placeholder-visual { background:linear-gradient(135deg,#e8f0fe,#d2e3fc); aspect-ratio:16/9; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:0.5rem; }
.map-placeholder-visual .icon { font-size:2.5rem; }
.map-placeholder-visual .title { font-family:'Nunito',sans-serif; font-size:1.1rem; font-weight:800; color:var(--blue); }
.map-placeholder-visual .sub { font-size:0.78rem; color:#4a7fcb; max-width:220px; text-align:center; line-height:1.5; }
.map-notice { margin:0 1.25rem 1.25rem; background:var(--blue-light); border-radius:var(--radius-sm); padding:0.85rem 1rem; font-size:0.8rem; color:var(--blue); font-weight:500; }
.map-stops-title { font-family:'Nunito',sans-serif; font-size:1rem; font-weight:800; padding:0 1.25rem; margin-bottom:0.75rem; }
.map-pill { margin:0 1.25rem 0.6rem; background:var(--white); border-radius:var(--radius-sm); padding:0.85rem 1rem; display:flex; align-items:center; gap:0.75rem; box-shadow:var(--shadow); cursor:pointer; text-decoration:none; color:var(--text); transition:transform 0.15s; }
.map-pill:hover { transform:translateY(-1px); }
.map-pill-num { width:30px; height:30px; border-radius:50%; background:var(--orange); color:#fff; display:flex; align-items:center; justify-content:center; font-family:'Nunito',sans-serif; font-size:0.85rem; font-weight:900; flex-shrink:0; }
.map-pill-name { font-weight:700; font-size:0.88rem; flex:1; }
.map-pill-addr { font-size:0.7rem; color:var(--text2); }
.map-pill-link { font-size:0.75rem; color:var(--blue); font-weight:700; }

/* ‚îÄ‚îÄ BOTTOM NAV ‚îÄ‚îÄ */
.bottom-nav { position:fixed; bottom:0; left:0; right:0; background:rgba(255,255,255,0.95); backdrop-filter:blur(20px); border-top:1px solid var(--border); display:flex; height:calc(68px + env(safe-area-inset-bottom)); padding-bottom:env(safe-area-inset-bottom); z-index:100; }
.nav-btn { flex:1; background:none; border:none; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:0.25rem; color:var(--text2); cursor:pointer; transition:color 0.2s; padding-top:0.5rem; }
.nav-btn.active { color:var(--orange); }
.nav-icon { font-size:1.2rem; line-height:1; }
.nav-lbl { font-size:0.55rem; letter-spacing:0.05em; font-weight:600; text-transform:uppercase; }

/* ‚îÄ‚îÄ CAMERA ‚îÄ‚îÄ */
#cam-overlay { position:fixed; inset:0; background:#000; z-index:800; display:none; flex-direction:column; }
#cam-overlay.on { display:flex; }
#cam-vid { flex:1; object-fit:cover; width:100%; }
.cam-ui { position:absolute; inset:0; display:flex; flex-direction:column; justify-content:space-between; padding:calc(1.5rem + env(safe-area-inset-top)) 1.25rem calc(1.5rem + env(safe-area-inset-bottom)); }
.cam-top { display:flex; justify-content:space-between; align-items:flex-start; }
.cam-tip-box { background:rgba(255,255,255,0.18); backdrop-filter:blur(12px); padding:0.85rem 1rem; max-width:220px; border-radius:var(--radius-sm); border:1px solid rgba(255,255,255,0.25); }
.cam-tip-lbl { font-size:0.6rem; font-weight:700; text-transform:uppercase; color:var(--yellow); margin-bottom:0.25rem; letter-spacing:0.1em; }
.cam-tip-txt { font-size:0.78rem; line-height:1.5; color:#fff; }
.cam-x { background:rgba(255,255,255,0.2); border:none; color:#fff; font-size:1.2rem; width:40px; height:40px; border-radius:50%; cursor:pointer; display:flex; align-items:center; justify-content:center; }
.cam-bottom { display:flex; justify-content:center; }
.shutter { width:74px; height:74px; border-radius:50%; background:#fff; border:5px solid rgba(255,255,255,0.4); cursor:pointer; box-shadow:0 0 0 3px rgba(255,255,255,0.2); transition:transform 0.1s; }
.shutter:active { transform:scale(0.9); }
#preview-overlay { position:fixed; inset:0; background:#000; z-index:900; display:none; flex-direction:column; align-items:center; justify-content:center; padding:2rem; }
#preview-overlay.on { display:flex; }
#preview-img { max-width:100%; max-height:65vh; border-radius:var(--radius-sm); object-fit:contain; }
.preview-row { margin-top:1.5rem; display:flex; gap:0.75rem; width:100%; max-width:320px; }
.prev-btn { flex:1; padding:0.85rem; border:none; cursor:pointer; font-family:'Nunito',sans-serif; font-size:0.95rem; font-weight:800; border-radius:var(--radius-sm); }
.prev-btn.retake { background:rgba(255,255,255,0.15); color:#fff; }
.prev-btn.save { background:var(--orange); color:#fff; }

/* ‚îÄ‚îÄ Walking figure animation ‚îÄ‚îÄ */
@keyframes walkBob { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-4px)} }
@keyframes walkLegF { 0%,100%{transform:rotate(-30deg)} 50%{transform:rotate(30deg)} }
@keyframes walkLegB { 0%,100%{transform:rotate(30deg)} 50%{transform:rotate(-30deg)} }
@keyframes walkArmF { 0%,100%{transform:rotate(25deg)} 50%{transform:rotate(-25deg)} }
@keyframes walkArmB { 0%,100%{transform:rotate(-25deg)} 50%{transform:rotate(25deg)} }

/* ‚îÄ‚îÄ Confetti animation ‚îÄ‚îÄ */
@keyframes confettiFall0  { 0%{transform:translateY(-20px) rotate(0deg);opacity:1} 100%{transform:translateY(110vh) rotate(360deg);opacity:0} }
@keyframes confettiFall1  { 0%{transform:translateY(-20px) rotate(0deg);opacity:1} 100%{transform:translateY(110vh) rotate(-380deg);opacity:0} }
@keyframes confettiFall2  { 0%{transform:translateY(-20px) rotate(0deg);opacity:1} 100%{transform:translateY(110vh) rotate(420deg);opacity:0} }
@keyframes confettiFall3  { 0%{transform:translateY(-20px) rotate(0deg);opacity:1} 100%{transform:translateY(110vh) rotate(-300deg);opacity:0} }
@keyframes confettiFall4  { 0%{transform:translateY(-20px) rotate(0deg);opacity:1} 100%{transform:translateY(110vh) rotate(340deg);opacity:0} }
#confetti-overlay { pointer-events:none; }
.confetti-piece {
  position:absolute; width:12px; height:12px; border-radius:2px; opacity:0;
}

/* Hide jt-bar when fullscreen video card is showing */
#journey-screen.fullscreen-video #jt-bar { display:none !important; }
#journey-screen.fullscreen-video #progress-dots { display:none !important; }

/* Fullscreen video: card-viewport fills all space, bottom bar floats over */
#journey-screen.fullscreen-video .card-viewport {
  position: fixed;
  inset: 0;
  z-index: 1;
}
#journey-screen.fullscreen-video #card-bottom {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  z-index: 20;
  background: transparent;
  border-top: none;
  padding-left: 1rem;
  padding-right: 1rem;
}
#journey-screen.fullscreen-video #card-bottom .card-prev-btn {
  background: rgba(255,255,255,0.35);
  color: #111;
  backdrop-filter: blur(8px);
  -webkit-backdrop-filter: blur(8px);
}
#journey-screen.fullscreen-video #card-bottom .card-prev-btn {
  background: rgba(0,0,0,0.45);
  color: rgba(255,255,255,0.9);
  backdrop-filter: blur(8px);
  -webkit-backdrop-filter: blur(8px);
}
#journey-screen.fullscreen-video #card-bottom .card-next-btn {
  background: rgba(255,107,53,0.75);
  backdrop-filter: blur(8px);
  -webkit-backdrop-filter: blur(8px);
}
</style>
  </head>
<body>

<!-- PASSWORD -->
<div id="pw-screen">
  <div class="pw-logo">ü™Å</div>
  <div class="pw-wordmark">Tonbi</div>
  <div class="pw-city">Rotterdam ¬∑ Self-Guided Tour</div>
  <div style="position:relative;width:100%;max-width:320px;margin-bottom:0.75rem;">
    <input class="pw-field" type="password" id="pw-in" placeholder="Enter your access code"
      autocomplete="off" autocorrect="off" autocapitalize="none" spellcheck="false"
      onkeydown="if(event.key==='Enter')unlock()" style="margin-bottom:0;padding-right:3rem;width:100%;">
    <button onclick="togglePw()" id="pw-eye"
      style="position:absolute;right:0.85rem;top:50%;transform:translateY(-50%);background:none;border:none;font-size:1.1rem;cursor:pointer;color:var(--text2);padding:0.25rem;">
      üëÅ
    </button>
  </div>
  <div class="pw-error" id="pw-err"></div>
  <button class="pw-btn" onclick="unlock()">Start the Tour ü™Å</button>
</div>

<!-- APP -->
<div id="app">
  <div id="home-screen">
    <div class="home-header">
      <div class="home-header-top">
        <div class="home-logo">
          <div class="home-logo-icon">ü™Å</div>
          <div><div class="home-logo-name">Tonbi</div><div class="home-logo-sub">Self-Guided Tour</div></div>
        </div>
        <div class="home-city-tag">Rotterdam üá≥üá±</div>
      </div>
    </div>
    <div class="hero-card">
      <img class="hero-img" src="https://rudyroams.github.io/tonbi-rotterdam/images/erasmus-bridge.jpeg" alt="Rotterdam">
      <div class="hero-overlay">
        <div class="hero-label">Walking Tour</div>
        <div class="hero-title">Rotterdam</div>
        <div class="hero-desc">Harbors, architecture & stories by a local filmmaker</div>
      </div>
    </div>
    <div class="stats-row">
      <div class="stat-card"><div class="stat-num">5</div><div class="stat-lbl">Stops</div></div>
      <div class="stat-card"><div class="stat-num">2h</div><div class="stat-lbl">Duration</div></div>
      <div class="stat-card"><div class="stat-num">5</div><div class="stat-lbl">Quizzes</div></div>
      <div class="stat-card"><div class="stat-num">5</div><div class="stat-lbl">Challenges</div></div>
    </div>
    <div class="start-btn-wrap">
      <button class="start-btn" onclick="startJourney(1)">‚ñ∂ Start Tour ‚Äî Stop 1</button>
    </div>
    <div class="section-title">Your Route</div>
    <div id="stop-list"></div>
    <div style="height:1rem"></div>
  </div>

  <div id="map-screen">
    <div class="map-top">
      <div class="map-top-title">Route Map</div>
      <div class="map-top-sub">All 5 stops ¬∑ Rotterdam ¬∑ ~2 hours walk</div>
    </div>
    <div id="mapbox-map"></div>
    <div class="map-stops-title" style="margin-top:1.25rem">Navigate to stops</div>
    <div id="map-pill-list"></div>
    <div style="height:1rem"></div>
  </div>

  <nav class="bottom-nav">
    <button class="nav-btn active" id="nav-home" onclick="showScreen('home')"><span class="nav-icon">üè†</span><span class="nav-lbl">Tour</span></button>
    <button class="nav-btn" id="nav-map" onclick="showScreen('map')"><span class="nav-icon">üìç</span><span class="nav-lbl">Map</span></button>
  </nav>
</div>

<!-- JOURNEY -->
<div id="journey-screen">
  <!-- Confetti overlay ‚Äî shown on correct quiz answer -->
  <div id="confetti-overlay" style="display:none;position:fixed;inset:0;z-index:999;pointer-events:none;">
    <lottie-player
      id="confetti-lottie"
      src="https://assets2.lottiefiles.com/packages/lf20_u4yrau84.json"
      background="transparent"
      speed="1"
      style="width:100%;height:100%;">
    </lottie-player>
  </div>
  <div class="jt-bar" id="jt-bar">
    <div class="jt-bar-top">
      <div id="dp-prog" style="margin-left:0;min-width:70px;font-family:'Nunito',sans-serif;font-size:0.85rem;font-weight:800;color:#ff6b35;letter-spacing:-0.01em;"></div>
      <div class="jt-stop-label" id="jt-label" style="flex:1;text-align:center;font-size:1.05rem;"></div>
      <button class="jt-close" onclick="closeJourney()">‚úï</button>
    </div>
    <div class="progress-dots" id="progress-dots"></div>
  </div>
  <div class="card-viewport">
    <div class="card-track" id="card-track"></div>
  </div>
  <div class="card-bottom" id="card-bottom">
    <button class="card-prev-btn" id="prev-btn" onclick="prevCard()">‚Üê Back</button>
    <button class="card-next-btn" id="next-btn" onclick="nextCard()">Continue ‚Üí</button>
  </div>
</div>

<!-- CAMERA -->
<div id="cam-overlay">
  <video id="cam-vid" autoplay playsinline muted></video>
  <canvas id="cam-canvas" style="display:none"></canvas>
  <div class="cam-ui">
    <div class="cam-top">
      <div class="cam-tip-box"><div class="cam-tip-lbl">Rudy's Tip</div><div class="cam-tip-txt" id="cam-tip"></div></div>
      <button class="cam-x" onclick="stopCam()">‚úï</button>
    </div>
    <div class="cam-bottom"><button class="shutter" onclick="snap()"></button></div>
  </div>
</div>
<div id="preview-overlay">
  <img id="preview-img" src="" alt="">
  <div class="preview-row">
    <button class="prev-btn retake" onclick="retake()">Retake</button>
    <button class="prev-btn save" onclick="savePhoto()">Save üì∏</button>
  </div>
</div>

<script>
// ‚ïê‚ïê DATA ‚ïê‚ïê
// NOTE: Replace the youtubeId values with your actual unlisted YouTube video IDs.
// To get an ID: upload to YouTube as Unlisted, copy the URL
// e.g. https://www.youtube.com/watch?v=ABC123XYZ ‚Üí ID is "ABC123XYZ"
// thumbUrl can be left as the stop image or use YouTube's auto-thumbnail:
// https://img.youtube.com/vi/YOUR_ID/hqdefault.jpg

const stops = [
  {
    id:1, name:"Erasmus Bridge", dutch:"Erasmusbrug",
    tagline:"Where Rotterdam announces itself to the world",
    img:"https://rudyroams.github.io/tonbi-rotterdam/images/erasmus-bridge.jpeg",
    mapUrl:"https://maps.google.com/?q=Erasmusbrug,Rotterdam",
    address:"Boompjeskade, 3011 XE Rotterdam",
    // Video: replace with your YouTube ID. Leave as null to hide video.
    youtubeId: "dQw4w9WgXcQ", // ‚Üê REPLACE with your actual video ID
    cloudflareId: "cdf7ca48be25d626e763da55c81765b8", cfStyle: "card",
    desc:"Called <em>The Swan</em> by locals, the Erasmus Bridge is Rotterdam's most iconic landmark. Completed in 1996, it connects the north and south banks of the Nieuwe Maas with a single asymmetric pylon. My grandfather worked the harbors visible from this very spot ‚Äî the view hasn't changed as much as you'd think.",
    rudy:"Stand at De Boeg monument and look south across the bridge at golden hour. The light on the cable stays turns everything into a painting. I've shot this spot hundreds of times and it never gets old.",
    challenge:{title:"The Swan Shot",desc:"Frame the bridge so one of the steel cables cuts diagonally across your shot from corner to corner. Get low ‚Äî crouch down or sit on the steps. The asymmetry is the magic.",tip:"Shoot into the light for drama. The silhouette of the cables against the sky beats a correctly exposed shot every time."},
    quiz:{img:"https://rudyroams.github.io/tonbi-rotterdam/images/erasmus-bridge.jpeg",q:"The Erasmus Bridge has a famous nickname. What do locals call it?",opts:["The Swan","The Needle","A very large bridge"],correct:0,explanation:"Locals call it <em>De Zwaan</em> ‚Äî The Swan ‚Äî because of the graceful curve of its single white pylon, which resembles a swan's neck."}
  },
  {
    id:2, name:"Witte Huis", dutch:"The White House",
    tagline:"Europe's first skyscraper, still standing proud",
    img:"https://rudyroams.github.io/tonbi-rotterdam/images/witte-huis.jpeg",
    mapUrl:"https://maps.google.com/?q=Witte+Huis+Rotterdam",
    address:"Geldersekade 1, 3011 EG Rotterdam",
    youtubeId: null,
    cloudflareId: "cdf7ca48be25d626e763da55c81765b8", cfStyle: "fullscreen",
    desc:"Built in 1898, the Witte Huis was the tallest office building in Europe when completed ‚Äî ten stories of ornate Art Nouveau stone. It survived the devastating bombing of 1940 almost miraculously, and stands today as a living link to Rotterdam before the war.",
    rudy:"When I show people the before-and-after photos of the 1940 bombing, standing right here, it always creates a silence. Everything around this building was destroyed. That moment always hits hard.",
    challenge:{title:"Old Meets New",desc:"Find an angle where the Witte Huis appears directly next to modern Rotterdam architecture. The contrast between the 1898 facade and today's glass-and-steel is the whole story of the city in one frame.",tip:"Step back further than you think. A slight zoom compresses old and new together ‚Äî much more dramatic."},
    quiz:{img:"https://rudyroams.github.io/tonbi-rotterdam/images/witte-huis.jpeg",q:"When was the Witte Huis completed, making it Europe's tallest office building?",opts:["1898","1924","It was built last Tuesday"],correct:0,explanation:"The Witte Huis was completed in 1898. At 10 stories, it was a genuine skyscraper for its era ‚Äî a bold statement from an ambitious city."}
  },
  {
    id:3, name:"Oude Haven", dutch:"Old Harbor",
    tagline:"The oldest harbor in Rotterdam, still full of life",
    img:"https://rudyroams.github.io/tonbi-rotterdam/images/oude-haven.jpeg",
    mapUrl:"https://maps.google.com/?q=Oudehaven+Rotterdam",
    address:"Oudehaven, 3011 KN Rotterdam",
    youtubeId: null,
    desc:"The Oude Haven dates back to 1325 ‚Äî this is where Rotterdam literally began. Today historic vessels bob alongside canal houses and the Cube Houses loom dramatically overhead. My family's connection to these harbors stretches back generations; working hands, heavy ropes, and the smell of the Maas.",
    rudy:"Early morning here is pure magic ‚Äî the boats reflect in still water before the city wakes up. But any time of day, the contrast between old vessels and the Cube Houses above is something completely unique to Rotterdam.",
    challenge:{title:"Reflections",desc:"Find a reflection of the Cube Houses or the historic vessels in the harbor water. Move around the edge ‚Äî the best reflections shift depending on exactly where you stand.",tip:"Crouch as low as possible to get your phone close to the water. The lower your angle, the longer and more dramatic the reflection."},
    quiz:{img:"https://rudyroams.github.io/tonbi-rotterdam/images/oude-haven.jpeg",q:"Approximately when was the Oude Haven first established?",opts:["1325","1600","Sometime during a rainy Tuesday in the 1400s"],correct:0,explanation:"The Oude Haven dates to 1325, making it the oldest part of Rotterdam's harbor system ‚Äî and essentially the birthplace of the city."}
  },
  {
    id:4, name:"Cube Houses", dutch:"Kubuswoningen",
    tagline:"Living tilted at 45¬∞ ‚Äî Rotterdam's most playful architecture",
    img:"https://rudyroams.github.io/tonbi-rotterdam/images/cube-houses.jpeg",
    mapUrl:"https://maps.google.com/?q=Kubuswoningen+Rotterdam",
    address:"Overblaak 70, 3011 MH Rotterdam",
    youtubeId: null,
    desc:"Designed by Piet Blom and completed in 1984, each cube house is tilted 45 degrees on a hexagonal pylon. Blom's concept: a village within a city, where each cube is a tree, together forming a forest. The result is disorienting, playful, and completely Rotterdam.",
    rudy:"Don't just look up at them from below. Find the path that runs underneath the bridge through the middle. From there you're completely surrounded ‚Äî it feels like being inside abstract architecture. That's my favourite spot.",
    challenge:{title:"Geometric Chaos",desc:"Look straight up from directly underneath the cubes and shoot vertically. The overlapping angles and windows create an almost abstract pattern. Try converting to black and white afterwards.",tip:"Tap the nearest cube edge to focus on it. The wide-angle distortion of your phone camera works beautifully here ‚Äî don't fight it."},
    quiz:{img:"https://rudyroams.github.io/tonbi-rotterdam/images/cube-houses.jpeg",q:"Who designed the Cube Houses, completed in 1984?",opts:["Piet Blom","Rem Koolhaas","A very confused carpenter"],correct:0,explanation:"Piet Blom designed the Cube Houses. His concept: 'living as an urban roof' ‚Äî each tilted cube a tree, together a forest canopy over the street."}
  },
  {
    id:5, name:"Markthal", dutch:"Market Hall",
    tagline:"A cathedral of food ‚Äî and the best ceiling in the Netherlands",
    img:"https://rudyroams.github.io/tonbi-rotterdam/images/markthal.jpeg",
    mapUrl:"https://maps.google.com/?q=Markthal+Rotterdam",
    address:"Dominee Jan Scharpstraat 298, 3011 GZ Rotterdam",
    youtubeId: null,
    desc:"Opened in 2014, the Markthal is a covered market with 228 apartments built into its horseshoe arch. The ceiling is covered in an 11,000 m¬≤ artwork called <em>Horn of Plenty</em>. Walk in, look up, and let your jaw drop. Then eat something ‚Äî I insist.",
    rudy:"The ceiling artwork is extraordinary but most people walk in and look at the stalls. Look up first. Always look up first. Then eat something ‚Äî raw herring with onion is non-negotiable.",
    challenge:{title:"The Big Ceiling",desc:"Walk to the very centre of the Markthal and shoot straight up at the ceiling artwork. Try a slow panorama sweep, or take a regular shot and experiment with the fisheye effect in editing.",tip:"The ceiling is brightly lit but the market below is darker ‚Äî tap the ceiling in your viewfinder so it exposes for the artwork, not the stalls."},
    quiz:{img:"https://rudyroams.github.io/tonbi-rotterdam/images/markthal.jpeg",q:"What is the name of the enormous artwork covering the Markthal ceiling?",opts:["Horn of Plenty","Sea of Flowers","11,000 m¬≤ of pure ambition"],correct:0,explanation:"The ceiling mural is called <em>Horn of Plenty</em> (Hoorn des Overvloeds), created by Arno Coenen and Iris Roskam. At 11,000 m¬≤ it's one of the largest artworks in the world."}
  }
];

// ‚ïê‚ïê STATE ‚ïê‚ïê
let camStream=null, lastTip='';
const quizAnswered={};
let currentStop=null, currentCardIdx=0, cards=[];
// Track which videos have been activated (to avoid re-loading)
const videoActivated={};

// ‚ïê‚ïê PASSWORD ‚ïê‚ïê
function togglePw(){
  const input=document.getElementById('pw-in');
  const eye=document.getElementById('pw-eye');
  input.type=input.type==='password'?'text':'password';
  eye.textContent=input.type==='password'?'üëÅ':'üôà';
}

function unlock(){
  const v=document.getElementById('pw-in').value.toLowerCase().trim();
  if(v === 'tonbi'){
    const pw=document.getElementById('pw-screen');
    pw.classList.add('exit');
    setTimeout(()=>{
      pw.style.display='none';
      document.getElementById('app').classList.add('show');
      try { showScreen('home'); } catch(e){ console.error('showScreen error:', e); }
    },500);
  } else {
    document.getElementById('pw-err').textContent='Incorrect code ‚Äî try again.';
    document.getElementById('pw-in').value='';
  }
}

// ‚ïê‚ïê SCREENS ‚ïê‚ïê
function showScreen(name){
  document.getElementById('home-screen').style.display=name==='home'?'block':'none';
  const mapEl=document.getElementById('map-screen');
  name==='map'?mapEl.classList.add('show'):mapEl.classList.remove('show');
  document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById('nav-'+name).classList.add('active');
}

// ‚ïê‚ïê LISTS ‚ïê‚ïê
function renderLists(){
  document.getElementById('stop-list').innerHTML=stops.map(s=>`
    <div class="stop-item" onclick="startJourney(${s.id})">
      <div class="stop-item-num">${s.id}</div>
      <img class="stop-item-img" src="${s.img}" alt="${s.name}" loading="lazy">
      <div class="stop-item-body">
        <div class="stop-item-name">${s.name}</div>
        <div class="stop-item-tag">${s.tagline}</div>
        <div class="stop-item-badges">
          ${s.youtubeId?'<span class="pill pill-photo">üé¨ Video</span>':''}
          <span class="pill pill-photo">üì∏ Challenge</span>
          <span class="pill pill-quiz">‚ùì Quiz</span>
        </div>
      </div>
      <div class="stop-item-arrow">‚Ä∫</div>
    </div>`).join('');

  document.getElementById('map-pill-list').innerHTML=stops.map(s=>`
    <a class="map-pill" href="${s.mapUrl}" target="_blank">
      <div class="map-pill-num">${s.id}</div>
      <div><div class="map-pill-name">${s.name}</div><div class="map-pill-addr">${s.address}</div></div>
      <div class="map-pill-link">Open ‚Üí</div>
    </a>`).join('');
}

// ‚ïê‚ïê VIDEO ‚ïê‚ïê
function openVideo(youtubeId){
  // Try YouTube app first, fall back to mobile web
  window.location.href = `youtube://watch?v=${youtubeId}`;
  setTimeout(()=>{
    window.open(`https://www.youtube.com/watch?v=${youtubeId}`, '_blank');
  }, 500);
}

function activateVideo(stopId){
  const s=stops.find(x=>x.id===stopId);
  if(!s.youtubeId) return;
  openVideo(s.youtubeId);
}




function initWalkAnim(stopId){
  const container = document.getElementById('walk-anim-'+stopId);
  if(!container || container._walkDone) return;
  container._walkDone = true;
  container.innerHTML = `
    <svg viewBox="0 0 60 80" width="60" height="80" style="overflow:visible;">
      <g style="animation:walkBob 0.5s ease-in-out infinite;transform-origin:30px 40px;">
        <!-- head -->
        <circle cx="30" cy="12" r="9" fill="#ff6b35"/>
        <!-- torso -->
        <line x1="30" y1="21" x2="30" y2="46" stroke="#ff6b35" stroke-width="4" stroke-linecap="round"/>
        <!-- front leg -->
        <g style="transform-origin:30px 46px;animation:walkLegF 0.5s ease-in-out infinite;">
          <line x1="30" y1="46" x2="18" y2="68" stroke="#ff6b35" stroke-width="4" stroke-linecap="round"/>
        </g>
        <!-- back leg -->
        <g style="transform-origin:30px 46px;animation:walkLegB 0.5s ease-in-out infinite;">
          <line x1="30" y1="46" x2="42" y2="68" stroke="#ff6b35" stroke-width="4" stroke-linecap="round"/>
        </g>
        <!-- front arm -->
        <g style="transform-origin:30px 26px;animation:walkArmF 0.5s ease-in-out infinite;">
          <line x1="30" y1="26" x2="16" y2="42" stroke="#ff6b35" stroke-width="3.5" stroke-linecap="round"/>
        </g>
        <!-- back arm -->
        <g style="transform-origin:30px 26px;animation:walkArmB 0.5s ease-in-out infinite;">
          <line x1="30" y1="26" x2="44" y2="42" stroke="#ff6b35" stroke-width="3.5" stroke-linecap="round"/>
        </g>
      </g>
    </svg>`;
}

const CONFETTI_COLORS = ['#ff6b35','#2d6be4','#ffcc00','#34c759','#e8295c','#af52de'];
function showConfetti(){
  const overlay = document.getElementById('confetti-overlay');
  const container = document.getElementById('confetti-lottie');
  if(!overlay || !container) return;
  container.innerHTML = '';
  overlay.style.display = 'block';
  const pieces = 28;
  for(let i=0; i<pieces; i++){
    const el = document.createElement('div');
    el.className = 'confetti-piece';
    el.style.cssText = `
      left:${5 + (i * 3.3) % 90}vw;
      top:-20px;
      background:${CONFETTI_COLORS[i % CONFETTI_COLORS.length]};
      width:${8 + i%5}px;
      height:${8 + i%4}px;
      border-radius:${i%3===0?'50%':'2px'};
      animation:confettiFall${i%5} ${1.5 + (i%5)*0.2}s ease-in ${i*0.07}s forwards;
    `;
    container.appendChild(el);
  }
  setTimeout(()=>{ overlay.style.display='none'; container.innerHTML=''; }, 3500);
}


function updateJourneyHeaderVisibility(){
  // Handled by renderJourney
}

function skipToTextFullscreen(stopId){
  const textEl = document.getElementById('text-section-'+stopId);
  if(textEl) textEl.style.display = 'block';
}

function skipToText(stopId){
  const textEl=document.getElementById(`text-section-${stopId}`);
  const videoWrap=document.getElementById(`video-wrap-${stopId}`);
  const skipLink=document.querySelector(`#video-wrap-${stopId}`)?.closest('.card')?.querySelector('.video-skip');
  if(textEl){ textEl.style.display='block'; }
  if(videoWrap){ videoWrap.style.display='none'; }
  if(skipLink){ skipLink.style.display='none'; }
}

// Auto-pause YouTube when scrolled out of view
function setupVideoObserver(stopId){
  const wrap=document.getElementById(`yt-wrap-${stopId}`);
  if(!wrap) return;
  const observer=new IntersectionObserver((entries)=>{
    entries.forEach(entry=>{
      if(!entry.isIntersecting && videoActivated[stopId]){
        // Post pause message to iframe
        const iframe=wrap.querySelector('iframe');
        if(iframe) iframe.contentWindow.postMessage('{"event":"command","func":"pauseVideo","args":""}','*');
      }
    });
  },{threshold:0.2});
  observer.observe(wrap);
}

// ‚ïê‚ïê CARDS ‚ïê‚ïê
function buildCards(stop){
  return [
    {type:'transition', stop},
    {type:'nav',        stop},
    {type:'desc',       stop},
    {type:'photo',      stop},
    {type:'quiz',       stop}
  ];
}

function renderCard(card, idx, total){
  const s = card.stop;
  const CF = 'https://customer-umijtu8zknmpubqb.cloudflarestream.com';

  // ‚îÄ‚îÄ TRANSITION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  if(card.type === 'transition'){
    const isFirst = s.id === 1;
    return `<div class="card" style="display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;padding:2rem 1.75rem;gap:1.2rem;">
      <div style="font-size:2.5rem;">${isFirst ? 'ü¶Ö' : 'üö∂'}</div>
      <div style="font-size:0.65rem;font-weight:700;color:var(--orange);text-transform:uppercase;letter-spacing:0.12em;">${isFirst ? 'Your journey begins' : 'Next Stop'}</div>
      <div style="font-family:'Nunito',sans-serif;font-size:1.6rem;font-weight:900;line-height:1.1;">${s.name}</div>
      <div style="font-size:0.9rem;color:var(--text2);">${s.tagline}</div>
    </div>`;
  }

  // ‚îÄ‚îÄ NAV MAP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  if(card.type === 'nav'){
    return `<div class="card nav-card" data-stop="${s.id}" data-type="nav" style="position:relative;overflow:hidden;">
      <div id="nav-map-${s.id}" style="position:absolute;inset:0;"></div>
      <div id="walk-anim-${s.id}" style="position:absolute;bottom:65px;left:12px;width:80px;height:80px;z-index:11;pointer-events:none;"></div>
      <div style="position:absolute;top:0;left:0;right:0;z-index:10;
        padding:calc(0.85rem + env(safe-area-inset-top)) 1.25rem 0.75rem;
        background:linear-gradient(to bottom,rgba(255,255,255,0.96) 65%,transparent);">
        <div style="font-size:0.65rem;font-weight:700;color:var(--orange);text-transform:uppercase;letter-spacing:0.12em;margin-bottom:0.1rem;">Navigating to</div>
        <div style="font-family:'Nunito',sans-serif;font-size:1.2rem;font-weight:900;">${s.name}</div>
      </div>
      <a href="https://www.google.com/maps/dir/?api=1&destination=${s.lat},${s.lng}" target="_blank"
        style="position:absolute;bottom:14px;left:50%;transform:translateX(-50%);z-index:12;
               display:inline-flex;align-items:center;gap:0.4rem;white-space:nowrap;
               background:white;border:1.5px solid var(--border);border-radius:99px;
               padding:0.45rem 1rem;font-size:0.78rem;font-weight:700;color:var(--text);
               text-decoration:none;box-shadow:0 2px 8px rgba(0,0,0,0.12);">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#4285F4" stroke-width="2.5"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7z"/><circle cx="12" cy="9" r="2.5" fill="#4285F4" stroke="none"/></svg>
        Open in Google Maps
      </a>
    </div>`;
  }

  // ‚îÄ‚îÄ DESC (video or text) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  if(card.type === 'desc'){
    // Cloudflare card style (stop 1 ‚Äî white gradient)
    if(s.cloudflareId && s.cfStyle === 'card'){
      return `<div class="card" data-stop="${s.id}" data-type="desc" style="position:relative;overflow:hidden;background:#000;padding:0;">
        <iframe src="${CF}/${s.cloudflareId}/iframe?autoplay=true&muted=false&loop=false&controls=true&preload=true"
          style="position:absolute;inset:0;width:100%;height:100%;border:0;"
          allow="accelerometer; gyroscope; autoplay; encrypted-media; picture-in-picture;" allowfullscreen></iframe>
        <div style="position:absolute;top:0;left:0;right:0;height:10%;z-index:9;pointer-events:none;
          background:linear-gradient(to bottom,#fff 0%,rgba(255,255,255,0.85) 40%,transparent 100%);"></div>
        <div style="position:absolute;bottom:0;left:0;right:0;height:10%;z-index:9;pointer-events:none;
          background:linear-gradient(to top,#fff 0%,rgba(255,255,255,0.85) 40%,transparent 100%);"></div>
        <div style="position:absolute;top:0;left:0;right:0;z-index:10;
          padding:calc(1.1rem + env(safe-area-inset-top)) 1.25rem 2rem;pointer-events:none;">
          <div style="font-family:'Nunito',sans-serif;font-size:1.4rem;font-weight:900;color:#111;line-height:1.1;">${s.name}</div>
          <div style="font-size:0.85rem;color:rgba(0,0,0,0.55);margin-top:0.2rem;">${s.tagline}</div>
        </div>
        <div style="position:absolute;bottom:calc(62px + env(safe-area-inset-bottom));right:1.1rem;z-index:25;">
          <a onclick="skipToText(${s.id})" style="cursor:pointer;color:rgba(0,0,0,0.35);font-size:0.72rem;text-decoration:underline;">Skip video</a>
        </div>
        <div id="text-section-${s.id}" style="display:none;position:absolute;inset:0;background:var(--white);z-index:20;padding:1.5rem;padding-top:calc(1.5rem + env(safe-area-inset-top));overflow-y:auto;">
          <div style="font-size:0.65rem;font-weight:700;color:var(--orange);text-transform:uppercase;letter-spacing:0.12em;margin-bottom:0.35rem;">Stop ${s.id} ¬∑ ${s.dutch}</div>
          <div class="arrival-title" style="margin-bottom:0.2rem;">${s.name}</div>
          <div class="arrival-tagline" style="margin-bottom:1rem;">${s.tagline}</div>
          <div class="arrival-text-body" style="margin-bottom:2rem;">${s.desc}</div>
          <div style="text-align:center;">
            <a onclick="document.getElementById('text-section-${s.id}').style.display='none'"
              style="cursor:pointer;display:inline-flex;align-items:center;gap:0.5rem;background:var(--orange);color:white;font-weight:700;font-size:0.85rem;padding:0.65rem 1.4rem;border-radius:99px;text-decoration:none;">
              ‚ñ∂ Watch video instead</a>
          </div>
        </div>
      </div>`;
    }
    // Cloudflare fullscreen style (stop 2 ‚Äî black gradient)
    if(s.cloudflareId && s.cfStyle === 'fullscreen'){
      return `<div class="card" data-stop="${s.id}" data-type="desc" style="position:relative;overflow:hidden;background:#000;padding:0;">
        <iframe src="${CF}/${s.cloudflareId}/iframe?autoplay=true&muted=false&loop=false&controls=true&preload=true"
          style="position:absolute;inset:0;width:100%;height:100%;border:0;"
          allow="accelerometer; gyroscope; autoplay; encrypted-media; picture-in-picture;" allowfullscreen></iframe>
        <div style="position:absolute;top:0;left:0;right:0;height:10%;z-index:9;pointer-events:none;
          background:linear-gradient(to bottom,#000 0%,rgba(0,0,0,0.85) 40%,transparent 100%);"></div>
        <div style="position:absolute;bottom:0;left:0;right:0;height:10%;z-index:9;pointer-events:none;
          background:linear-gradient(to top,#000 0%,rgba(0,0,0,0.85) 40%,transparent 100%);"></div>
        <div style="position:absolute;top:0;left:0;right:0;z-index:10;
          padding:calc(1.1rem + env(safe-area-inset-top)) 1.25rem 2rem;pointer-events:none;">
          <div style="font-family:'Nunito',sans-serif;font-size:1.4rem;font-weight:900;color:white;line-height:1.1;">${s.name}</div>
          <div style="font-size:0.85rem;color:rgba(255,255,255,0.7);margin-top:0.2rem;">${s.tagline}</div>
        </div>
        <div style="position:absolute;bottom:calc(62px + env(safe-area-inset-bottom));right:1.1rem;z-index:25;">
          <a onclick="skipToTextFullscreen(${s.id})" style="cursor:pointer;color:rgba(255,255,255,0.45);font-size:0.72rem;text-decoration:underline;">Skip video</a>
        </div>
        <div id="text-section-${s.id}" style="display:none;position:absolute;inset:0;background:var(--white);z-index:20;padding:1.5rem;padding-top:calc(1.5rem + env(safe-area-inset-top));overflow-y:auto;">
          <div style="font-size:0.65rem;font-weight:700;color:var(--orange);text-transform:uppercase;letter-spacing:0.12em;margin-bottom:0.35rem;">Stop ${s.id} ¬∑ ${s.dutch}</div>
          <div class="arrival-title" style="margin-bottom:0.2rem;">${s.name}</div>
          <div class="arrival-tagline" style="margin-bottom:1rem;">${s.tagline}</div>
          <div class="arrival-text-body" style="margin-bottom:2rem;">${s.desc}</div>
          <div style="text-align:center;">
            <a onclick="document.getElementById('text-section-${s.id}').style.display='none'"
              style="cursor:pointer;display:inline-flex;align-items:center;gap:0.5rem;background:var(--orange);color:white;font-weight:700;font-size:0.85rem;padding:0.65rem 1.4rem;border-radius:99px;text-decoration:none;">
              ‚ñ∂ Watch video instead</a>
          </div>
        </div>
      </div>`;
    }
    // Plain text
    return `<div class="card" data-stop="${s.id}" data-type="desc" style="padding:1.25rem;overflow-y:auto;">
      <div style="font-size:0.65rem;font-weight:700;color:var(--orange);text-transform:uppercase;letter-spacing:0.12em;margin-bottom:0.35rem;">Stop ${s.id} ¬∑ ${s.dutch}</div>
      <div class="arrival-title" style="margin-bottom:0.2rem;">${s.name}</div>
      <div class="arrival-tagline" style="margin-bottom:1rem;">${s.tagline}</div>
      <div class="arrival-text-body">${s.desc}</div>
    </div>`;
  }

  // ‚îÄ‚îÄ PHOTO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  if(card.type === 'photo'){
    return `<div class="card" data-stop="${s.id}" data-type="photo" style="padding:0;position:relative;overflow:hidden;">
      <img src="${s.photo}" alt="${s.name}" style="width:100%;height:100%;object-fit:cover;display:block;">
      <div style="position:absolute;bottom:0;left:0;right:0;padding:1.5rem 1.25rem 1.25rem;
        background:linear-gradient(to top,rgba(0,0,0,0.65) 0%,transparent 100%);">
        <div style="font-size:0.65rem;font-weight:700;color:rgba(255,255,255,0.7);text-transform:uppercase;letter-spacing:0.12em;margin-bottom:0.2rem;">Stop ${s.id} ¬∑ ${s.dutch}</div>
        <div style="font-family:'Nunito',sans-serif;font-size:1.3rem;font-weight:900;color:white;">${s.name}</div>
      </div>
    </div>`;
  }

  // ‚îÄ‚îÄ QUIZ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  if(card.type === 'quiz'){
    const q = s.quiz;
    return `<div class="card" data-stop="${s.id}" data-type="quiz" style="padding:1.5rem;overflow-y:auto;">
      <div style="font-size:0.65rem;font-weight:700;color:var(--blue);text-transform:uppercase;letter-spacing:0.12em;margin-bottom:0.5rem;">Quick Quiz ¬∑ Stop ${s.id}</div>
      <div style="font-family:'Nunito',sans-serif;font-size:1.1rem;font-weight:800;line-height:1.35;margin-bottom:1.5rem;">${q.question}</div>
      <div style="display:flex;flex-direction:column;gap:0.6rem;" id="quiz-opts-${s.id}">
        ${q.options.map((opt,i)=>`
        <button class="quiz-opt" onclick="answerQuiz(${s.id},${i})" id="qopt-${s.id}-${i}"
          style="text-align:left;background:var(--bg);border:2px solid var(--border);border-radius:12px;
                 padding:0.75rem 1rem;font-family:'DM Sans',sans-serif;font-size:0.9rem;cursor:pointer;">
          <span style="font-weight:700;color:var(--orange);margin-right:0.5rem;">${String.fromCharCode(65+i)}</span>${opt}
        </button>`).join('')}
      </div>
      <div id="quiz-result-${s.id}" style="display:none;margin-top:1.25rem;padding:1rem;border-radius:12px;text-align:center;"></div>
    </div>`;
  }

  return `<div class="card" style="padding:1.25rem;"><p>Unknown: ${card.type}</p></div>`;
}

function answerQuiz(stopId, optIdx){
  const stop = stops.find(s=>s.id===stopId);
  if(!stop) return;
  const opts = document.querySelectorAll(`#quiz-opts-${stopId} .quiz-opt`);
  opts.forEach((btn,i)=>{
    btn.disabled = true;
    if(i===stop.quiz.correct){
      btn.style.background='#d1fae5'; btn.style.borderColor='#34c759'; btn.style.color='#065f46';
    } else if(i===optIdx && optIdx!==stop.quiz.correct){
      btn.style.background='#fee2e2'; btn.style.borderColor='#ef4444'; btn.style.color='#991b1b';
    }
  });
  const result = document.getElementById(`quiz-result-${stopId}`);
  if(result){
    result.style.display='block';
    if(optIdx===stop.quiz.correct){
      result.style.background='#d1fae5'; result.style.borderColor='#34c759';
      result.innerHTML=`<div style="font-size:1.3rem;margin-bottom:0.3rem;">‚úÖ</div><div style="font-weight:700;color:#065f46;">Correct!</div><div style="font-size:0.85rem;color:#065f46;margin-top:0.25rem;">${stop.quiz.explanation||''}</div>`;
      setTimeout(()=>showConfetti(), 300);
    } else {
      result.style.background='#fee2e2';
      result.innerHTML=`<div style="font-size:1.3rem;margin-bottom:0.3rem;">‚ùå</div><div style="font-weight:700;color:#991b1b;">Not quite!</div><div style="font-size:0.85rem;color:#991b1b;margin-top:0.25rem;">The answer was: ${stop.quiz.options[stop.quiz.correct]}</div>`;
    }
  }
}

function initNavMap(stopId){
  const stop = stops.find(s=>s.id===stopId);
  if(!stop) return;
  const container = document.getElementById(`nav-map-${stopId}`);
  if(!container || container._mapDone) return;
  container._mapDone = true;
  if(typeof mapboxgl === 'undefined'){ setTimeout(()=>initNavMap(stopId),500); return; }
  const map = new mapboxgl.Map({
    container: container,
    style: 'mapbox://styles/mapbox/streets-v12',
    center: [stop.lng, stop.lat],
    zoom: 14,
    interactive: false
  });
  map.on('load',()=>{
    new mapboxgl.Marker({color:'#ff6b35'}).setLngLat([stop.lng,stop.lat]).addTo(map);
  });
}


function renderJourney(){
  const currentCard = cards[currentCardIdx];
  const isNavCard = currentCard && (currentCard.type==='nav' || currentCard.type==='transition');
  const isFullscreenVideo = currentCard && currentCard.type==='desc' && currentCard.stop &&
    (currentCard.stop.cfStyle==='fullscreen' || currentCard.stop.cfStyle==='card');

  // jt-bar visibility
  const jtBar = document.getElementById('jt-bar');
  const dots  = document.getElementById('progress-dots');
  if(jtBar) jtBar.style.display = (isNavCard || isFullscreenVideo) ? 'none' : 'block';
  if(dots)  dots.style.display  = (isNavCard || isFullscreenVideo) ? 'none' : 'flex';

  // Stop label
  const label = document.getElementById('jt-label');
  const prog  = document.getElementById('dp-prog');
  if(label) label.textContent = currentStop ? currentStop.name : '';
  if(prog)  prog.textContent  = currentStop ? `Stop ${currentStop.id} of ${stops.length}` : '';

  // Progress dots
  if(dots){
    const contentCards = cards.slice(2);
    const contentIdx = currentCardIdx - 2;
    dots.innerHTML = contentCards.map((_,i)=>`
      <div class="dot ${i===contentIdx?'active':i<contentIdx?'done':''}"
           style="width:${i===contentIdx?'20px':'8px'}"></div>`).join('');
  }

  // Render cards
  const track = document.getElementById('card-track');
  if(track) track.innerHTML = cards.map((card,i)=>renderCard(card,i,cards.length)).join('');

  updateCardPosition(false);
  updateNavBtns();

  // Toggle fullscreen class on journey screen
  const js = document.getElementById('journey-screen');
  if(js) js.classList.toggle('fullscreen-video', !!isFullscreenVideo);
}

function updateCardPosition(animate=true){
  const track = document.getElementById('card-track');
  if(!track) return;
  if(!animate){ track.style.transition='none'; }
  track.style.transform = `translateX(-${currentCardIdx * 100}%)`;
  if(!animate) setTimeout(()=>{ track.style.transition=''; }, 50);
}

function nextCard(){
  if(currentCardIdx < cards.length-1){
    currentCardIdx++;
    renderJourney();
    const activeCard = cards[currentCardIdx];
    if(activeCard && activeCard.type==='nav'){
      setTimeout(()=>{
        updateJourneyHeaderVisibility();
        initNavMap(activeCard.stop.id);
        initWalkAnim(activeCard.stop.id);
      }, 100);
    } else {
      updateJourneyHeaderVisibility();
    }
  }
}

function prevCard(){
  if(currentCardIdx > 0){
    currentCardIdx--;
    renderJourney();
    updateJourneyHeaderVisibility();
    const activeCard = cards[currentCardIdx];
    if(activeCard && activeCard.type==='nav'){
      setTimeout(()=>{ initNavMap(activeCard.stop.id); initWalkAnim(activeCard.stop.id); }, 100);
    }
  }
}

function updateNavBtns(){
  const prev = document.getElementById('prev-btn');
  const next = document.getElementById('next-btn');
  if(!prev||!next) return;
  prev.style.display = currentCardIdx===0 ? 'none' : '';
  next.textContent = currentCardIdx===cards.length-1 ? 'Finish Tour ‚úì' : 'Continue ‚Üí';
}

function closeJourney(){
  document.getElementById('journey-screen').classList.remove('show');
  showScreen('home');
}

function startJourney(stopId){
  const stop = stops.find(s=>s.id===stopId);
  if(!stop) return;
  currentStop = stop;
  currentCardIdx = 0;
  cards = buildCards(stop);
  document.getElementById('journey-screen').classList.add('show');
  renderJourney();
  updateJourneyHeaderVisibility();
}

function stopCam(){ 
  const overlay = document.getElementById('cam-overlay');
  if(overlay) overlay.style.display='none';
  const vid = document.getElementById('cam-vid');
  if(vid && vid.srcObject){ vid.srcObject.getTracks().forEach(t=>t.stop()); vid.srcObject=null; }
}

function showScreen(name){
  ['home-screen','map-screen'].forEach(id=>{
    const el = document.getElementById(id);
    if(el) el.style.display = id===name+'-screen' ? 'block' : 'none';
  });
  document.querySelectorAll('.nav-btn').forEach(btn=>{
    btn.classList.toggle('active', btn.dataset.screen===name);
  });
}

// ‚îÄ‚îÄ Init ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.addEventListener('DOMContentLoaded',()=>{
  renderLists();
  showScreen('home');
});
</script>
</body>
</html>
